# AnnData Design Inspector

A Claude Code skill for inspecting and visualizing experimental designs from AnnData `.h5ad` files.

## Overview

This skill uses HDF5 command-line tools (`h5ls` and `h5dump`) to extract experimental design information from single-cell data stored in `.h5ad` format, converts it to the [edviz](https://github.com/vals/edviz) experimental design grammar, and generates professional visualizations automatically.

### Key Features

- **Fast extraction**: Uses HDF5 command-line tools (no need to load entire file into memory)
- **Grammar-based representation**: Outputs designs in edviz's standardized DSL
- **Automatic visualization**: Generates appropriate diagrams (trees for nested, grids for factorial designs)
- **Auto-installation**: Automatically installs edviz from GitHub when needed

## Files

- **SKILL.md** - Main skill definition with YAML frontmatter and workflow instructions
- **TESTING.md** - Comprehensive testing guide
- **create_test_data.py** - Generate test .h5ad file with nested experimental design
- **Python Scripts:**
  - `scripts/check_edviz.py` - Check for and auto-install edviz from GitHub
  - `scripts/design_to_grammar.py` - Convert design structure to edviz grammar notation
- **Helper Scripts** (automatically located via $SKILL_DIR):
  - `list_factors.sh` - List all categorical factors in a file
  - `extract_categories.sh` - Extract category names from a factor
  - `count_cells.sh` - Count cells per category
  - `detect_nesting.sh` - Detect if factors are nested or crossed
  - `check_tools.sh` - Check if HDF5 tools are installed

## Prerequisites

HDF5 command-line tools (`h5ls` and `h5dump`) must be installed:

**macOS:**
```bash
brew install hdf5
```

**Linux (Debian/Ubuntu):**
```bash
sudo apt-get install hdf5-tools
```

**Check installation:**
```bash
./check_tools.sh
```

## Helper Scripts Usage

### check_tools.sh
Check if HDF5 tools are installed, optionally install them:
```bash
./check_tools.sh              # Check only
./check_tools.sh --install    # Install if missing
```

### list_factors.sh
List all categorical factors (Groups) in the obs section:
```bash
./list_factors.sh <h5ad_file>
```

Example:
```bash
./list_factors.sh data.h5ad
# Output:
# cell_type
# genotype
# sample
```

### extract_categories.sh
Extract category names from a specific factor:
```bash
./extract_categories.sh <h5ad_file> <factor_name>
```

Example:
```bash
./extract_categories.sh data.h5ad genotype
# Output:
# KeapKO
# KeapWT
```

### count_cells.sh
Count how many cells belong to each category:
```bash
./count_cells.sh <h5ad_file> <factor_name>
```

Example:
```bash
./count_cells.sh data.h5ad sample
# Output:
# KeapKO_tumor_1:5103
# KeapKO_tumor_2:3881
# KeapWT_tumor_1:7904
# KeapWT_tumor_2:4537
```

### detect_nesting.sh
Detect if factor B is nested within factor A or if they're crossed:
```bash
./detect_nesting.sh <h5ad_file> <factor_a> <factor_b>
```

Example:
```bash
./detect_nesting.sh data.h5ad genotype sample
# Output:
# nested
```

## Using the Skill

The skill automatically:
1. Validates the .h5ad file
2. Checks for and installs edviz if needed
3. Identifies all experimental factors
4. Extracts categories and cell counts
5. Detects design structure (nested vs crossed)
6. Generates edviz grammar string representing the design
7. Renders visualizations using edviz (or fallback to custom ASCII diagrams)
8. Shows cell count distributions

### edviz Grammar

The skill outputs designs in [edviz grammar format](https://github.com/vals/edviz/blob/main/GRAMMAR.md), which provides a standardized way to represent experimental designs:

- `>` (nesting): `Genotype(2) > Sample(4)` - samples nested within genotypes
- `×` (crossing): `Genotype(2) × Timepoint(3)` - full factorial design
- `:` (classification): `Sample(4) : CellType(6)` - cell types classified within samples
- `(n)` - balanced counts
- `[n1|n2|n3]` - unbalanced counts
- `~nk` - approximate large counts (e.g., ~21k cells)

## Example Output

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        AnnData Experimental Design Inspector
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

File: GSE290106_analysed.h5ad
Size: 602 MB
Total Cells: 21,417

Experimental Factors Detected:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  • genotype (2 levels): KeapKO, KeapWT
  • sample (4 levels): nested within genotype
  • cell_type (6 levels): CAF, DC, Macrophages, NK cells, Neutrophils, Tumor cells

Design Structure: Hierarchical (Nested)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

edviz Grammar:
  Genotype(2) > Sample(4) : Cell Type(6)

Visualization (generated by edviz):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌──────────────────── Design Structure ────────────────────┐
│                                                          │
│ Genotype(2)                                              │
│    ↓                                                     │
│ Sample(4)                                                │
│    :                                                     │
│                                                          │
│ CellType(6)                                              │
│                                                          │
└──────────────────────────────────────────────────────────┘

Sample Distribution:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
KeapKO_tumor_1    ████████████░░░░░░░░░   5,103  (23.8%)
KeapKO_tumor_2    ██████████░░░░░░░░░░░   3,881  (18.1%)
KeapWT_tumor_1    ████████████████░░░░░   7,904  (36.9%)
KeapWT_tumor_2    ███████████░░░░░░░░░░   4,537  (21.2%)
```

## Design Types Supported

- **Nested/Hierarchical**: Samples nested within conditions
- **Crossed/Factorial**: All combinations of factors exist
- **Mixed**: Combination of nested and crossed factors

## Development

To add new features:
1. Update `SKILL.md` with new instructions
2. Create helper scripts for complex operations
3. Test with various .h5ad file structures

## Installation

### As a Project Skill
Clone this repository into your project's `.claude/skills/` directory:

```bash
mkdir -p .claude/skills
cd .claude/skills
git clone https://github.com/YOUR_USERNAME/anndata-design-inspector.git
```

### As a Personal Skill
Clone into your personal Claude skills directory:

```bash
mkdir -p ~/.claude/skills
cd ~/.claude/skills
git clone https://github.com/YOUR_USERNAME/anndata-design-inspector.git
```

The skill will be automatically available in Claude Code after installation.

### Testing

See [TESTING.md](TESTING.md) for comprehensive testing instructions. Quick test:

```bash
# Create a test file
python create_test_data.py

# Ask Claude in this directory:
# "Inspect the experimental design in test_experiment.h5ad"
```

### How It Works

This is a **model-invoked skill** - Claude automatically activates it when you mention analyzing `.h5ad` files or experimental designs. You don't need to manually invoke it.

**Example triggers:**
- "Inspect this h5ad file and show me the experimental design"
- "What's the structure of experiment.h5ad?"
- "Analyze the design in my single-cell data file"

**Allowed Tools:**
The skill uses `allowed-tools: Bash, Read, Glob, Grep` in its YAML frontmatter, which restricts Claude to:
- **Bash** - Execute shell commands (h5ls, h5dump, python, helper scripts)
- **Read** - Read file contents
- **Glob** - Find files by pattern
- **Grep** - Search within files

This focused set of tools is sufficient for analyzing h5ad files while maintaining appropriate guardrails.

## About edviz Integration

This skill uses [edviz](https://github.com/vals/edviz) to provide standardized experimental design grammar and visualization. Key benefits:

- **Standardized notation**: Learn once, use everywhere
- **Machine-readable**: Grammar strings can be parsed and validated
- **Publication-ready**: Professional diagrams for papers and presentations
- **Extensible**: Grammar supports complex designs (confounding, batch effects, etc.)

For more details on the grammar syntax, see the [edviz GRAMMAR.md](https://github.com/vals/edviz/blob/main/GRAMMAR.md) documentation.

### Why Reference vs Include GRAMMAR.md?

This skill references edviz's GRAMMAR.md from GitHub rather than including a copy because:
- **Single source of truth**: As edviz evolves, documentation stays current
- **Installed package**: edviz is auto-installed when the skill runs
- **Community standard**: Users learn the grammar once and can use it across tools

## License

MIT
